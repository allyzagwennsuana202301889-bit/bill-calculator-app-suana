<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Electricity Bill Calculator</title>
<link rel="stylesheet" href="cal_page.css" />

</head>

<body>
<div class="nav">
    <h1>Electricity Bill Calculator</h1>
    <img src="callogo1.png" alt="logo" />
    <div class="udash">
        <a href="profile_page.html"><img src="clean logo1.png" alt="pfp" /></a>
    </div>
</div>

<div class="user">
    <label>Month</label>
    <input type="text" id="month" />
    <label>Power Consumption (kWh)</label>
    <input type="number" id="power_consumption" />
    <label>Cost per kWh</label>
    <input type="number" id="cost_per_kwh" />
</div>

<div class="initiate">
    <label>Total Bills:</label>
    <input type="text" id="total" readonly />
    <button type="button" id="btn_calculate">Calculate</button>
</div>

<br />

<div class="sec">
    <label>Bill History</label>
    <button type="button" id="clear_table">Clear Table</button>
</div>

<br />

<div class="operation">
    <table id="results_table">
        <tr>
            <th>Month</th>
            <th>Power Consumption</th>
            <th>Cost per kWh</th>
            <th>Result</th>
        </tr>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>
<script src="auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    await initAuth();
    await loadHistory();

    const btn_calculate = document.getElementById("btn_calculate");
    btn_calculate.addEventListener("click", async () => {
        const month = document.getElementById("month");
        const power = document.getElementById("power_consumption");
        const cost = document.getElementById("cost_per_kwh");
        const total = document.getElementById("total");

        if (!month.value || !power.value || !cost.value) {
            alert("Please fill in all fields!");
            return;
        }

        const user = await getCurrentUser();
        if (!user) {
            alert("You must be logged in to save calculations!");
            window.location.href = "login.html";
            return;
        }

        const resultValue = parseFloat(cost.value) * parseFloat(power.value);
        total.value = resultValue.toFixed(2);

        const { data, error } = await supabaseClient
            .from("calculations")
            .insert([{
                user_id: user.id,
                month: month.value,
                power_consumption: parseFloat(power.value),
                cost_per_kwh: parseFloat(cost.value),
                result: resultValue
            }])
            .select();

        if (error) console.error("Error saving calculation:", error);

        addRowToTable(data[0]);

        month.value = "";
        power.value = "";
        cost.value = "";
    });

    const clear_table = document.getElementById("clear_table");
    clear_table.addEventListener("click", async () => {
        const user = await getCurrentUser();
        if (!user) return alert("You must be logged in to clear history.");
        if (!confirm("Are you sure you want to clear all your history?")) return;

        const { error } = await supabaseClient
            .from("calculations")
            .delete()
            .eq("user_id", user.id);

        if (error) {
            console.error("Error clearing history:", error);
            return alert("Failed to clear history. Try again.");
        }

        const table = document.getElementById("results_table");
        while (table.rows.length > 1) table.deleteRow(1);
        alert("History cleared successfully!");
    });
});

async function loadHistory() {
    const user = await getCurrentUser();
    if (!user) return;

    const { data, error } = await supabaseClient
        .from("calculations")
        .select("*")
        .eq("user_id", user.id)
        .order("id", { ascending: true });

    if (error) return console.error(error);

    data.forEach(calc => addRowToTable(calc));
}

function addRowToTable(calc) {
    const table = document.getElementById("results_table");
    const row = table.insertRow(-1);
    row.classList.add("table-row");

    const keys = ["month", "power_consumption", "cost_per_kwh", "result"];
    keys.forEach((key, i) => {
        const cell = row.insertCell(i);

        // Create wrapper inside the cell
        const wrapper = document.createElement("div");
        wrapper.classList.add("row-content-wrapper");

        // Row content
        const content = document.createElement("div");
        content.classList.add("row-content");
        content.textContent = i === 0 ? calc.month
                            : i === 1 ? calc.power_consumption.toFixed(2)
                            : i === 2 ? "₱ " + calc.cost_per_kwh.toFixed(2)
                            : "₱ " + calc.result.toFixed(2);

        wrapper.appendChild(content);

        // Add delete button only in first cell
        if (i === 0) {
            const deleteBtn = document.createElement("button");
            deleteBtn.classList.add("delete-btn");
            deleteBtn.textContent = "Delete";
            wrapper.appendChild(deleteBtn);

            // Delete functionality
            deleteBtn.addEventListener("click", async e => {
                e.stopPropagation();
                const user = await getCurrentUser();
                if (!user) return alert("Not logged in");

                const { error } = await supabaseClient
                    .from("calculations")
                    .delete()
                    .eq("id", calc.id);
                if (error) return console.error(error);

                row.remove();
            });
        }

        cell.appendChild(wrapper);
    });

    // Toggle active class on row click
    row.addEventListener("click", () => {
        row.classList.toggle("active");
    });
}



</script>
</body>
</html>
