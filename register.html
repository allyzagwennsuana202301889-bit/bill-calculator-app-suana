<!DOCTYPE html>
<html>
<head>
    <title>Electricity Bill Calculator - Sign Up</title>
    <link rel="stylesheet" href="signingin.css">
</head>
<body>

<!-- NAV BAR -->
<div class="nav">
    <h1>Sign Up</h1>
    <img src="callogo1.png" alt="logo">
</div>

<!-- SIGN UP FORM -->
<div class="user_info">
    <div class="username">
        <input type="text" placeholder="Username" id="reg_name">
    </div>

    <div class="useradd"> 
        <input type="text" placeholder="Address" id="reg_address">
    </div>

    <div class="usernum">
        <input type="text" placeholder="Phone" id="reg_phone">
    </div>

    <div class="usermail">
        <input type="text" placeholder="Email" id="reg_email">
    </div>

    <div class="userpass">
        <input type="password" placeholder="Password" id="reg_password">
    </div>

    <div class="userconfirm">
        <input type="password" placeholder="Confirm Password" id="reg_confirm_password">
    </div>
</div>

<!-- SIGN UP BUTTON -->
<div class="sign">
    <button type="button" onclick="handleRegister()">Sign Up</button>
</div>

<!-- BACK BUTTON -->
<div class="bck">
    <a href="index.html"><img src="back2.png"></a>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>
<script src="auth.js"></script>

<script>
// Handle user registration
async function handleRegister() {
    const username = document.getElementById("reg_name").value;
    const address = document.getElementById("reg_address").value;
    const phone = document.getElementById("reg_phone").value;
    const email = document.getElementById("reg_email").value;
    const password = document.getElementById("reg_password").value;
    const confirmPassword = document.getElementById("reg_confirm_password").value;

    if (!username || !email || !password || !confirmPassword) {
        alert("Please fill in all fields!");
        return;
    }

    if (password !== confirmPassword) {
        alert("Passwords do not match!");
        return;
    }

    if (password.length < 6) {
        alert("Password must be at least 6 characters long!");
        return;
    }

    try {
        // 1️⃣ Sign up the user
        const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({
            email: email,
            password: password
        });

        if (signUpError) {
            alert("Registration failed: " + signUpError.message);
            return;
        }

        // 2️⃣ Sign in immediately to create a valid session
        const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (signInError) {
            alert("Login after signup failed: " + signInError.message);
            return;
        }

        const userId = signInData.user.id;

        // 3️⃣ Insert the profile now that user is authenticated
        const { error: profileError } = await supabaseClient
            .from('profiles')
            .insert({
                id: userId,
                username: username,
                address: address,
                phone: phone
            });

        if (profileError) {
            console.error("Profile creation error:", profileError);
            alert("Registration succeeded but failed to create profile.");
            return;
        }

        alert("Registration successful! You are now logged in.");
        window.location.href = "calculator_page.html";

    } catch (err) {
        alert("An unexpected error occurred: " + err.message);
    }
}
</script>

</body>
</html>
