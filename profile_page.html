<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Electricity Bill Calculator - Profile</title>
<link rel="stylesheet" href="pfp.css" />
</head>
<body>

<div class="nav">
    <div class="pfpname">
        <input type="text" id="profile_name" placeholder="Username" readonly />
    </div>
    <div class="udash">
        <img src="clean logo1.png" alt="pfp" />
    </div>
</div>

<div class="box">
    <div class="form-row">
        <label for="profile_address">Address:</label>
        <input type="text" id="profile_address" placeholder="Address" readonly />
    </div>
    <div class="form-row">
        <label for="profile_phone">Phone No:</label>
        <input type="text" id="profile_phone" placeholder="Phone Number" readonly />
    </div>
    <div class="form-row">
        <label for="profile_email_edit">Email:</label>
        <input type="email" id="profile_email_edit" placeholder="Email" readonly />
    </div>

    <div class="passout">
        <a href="changepass.html">Change Password</a>
        <button onclick="handleLogout()">Log out</button>
    </div>
</div>

<button class="savebtn" id="editBtn" onclick="enableEditing()">Edit Profile</button>
<button class="savebtn" id="saveBtn" onclick="handleProfileUpdate()" style="display:none;">Save Changes</button>

<div class="rewind">
    <a href="calculator_page.html"><img src="back2.png" alt="back" /></a>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>
<script src="auth.js"></script>


<script>
// Load page and enforce authentication
document.addEventListener("DOMContentLoaded", async () => {
    const session = await initAuth();
    if (session) {
        loadUserProfile();
    }
});

// Load user profile (profiles table + auth email)
async function loadUserProfile() {
    const session = await checkAuth();
    if (!session) return;

    const userId = session.user.id;

    // Fetch from profiles table
    const { data: profile, error } = await supabaseClient
        .from("profiles")
        .select("username, address, phone")
        .eq("id", userId)
        .single();

    if (error) {
        console.error("Profile load error:", error);
        return;
    }

    // Fill inputs
    document.getElementById("profile_name").value = profile.username || "";
    document.getElementById("profile_address").value = profile.address || "";
    document.getElementById("profile_phone").value = profile.phone || "";

    // Email from auth.users (NOT in profiles table)
    document.getElementById("profile_email_edit").value = session.user.email;
}

// Enable editing
function enableEditing() {
    document.getElementById("profile_name").readOnly = false;
    document.getElementById("profile_address").readOnly = false;
    document.getElementById("profile_phone").readOnly = false;

    // Email cannot be edited unless you explicitly allow updating Auth.email
    document.getElementById("profile_email_edit").readOnly = true;

    document.getElementById("editBtn").style.display = "none";
    document.getElementById("saveBtn").style.display = "block";
}

// Save updated profile
async function handleProfileUpdate() {
    const session = await checkAuth();
    if (!session) return alert("You must be logged in!");

    const userId = session.user.id;

    const username = document.getElementById("profile_name").value;
    const address = document.getElementById("profile_address").value;
    const phone = document.getElementById("profile_phone").value;

    // Update the profiles table ONLY
    const { error } = await supabaseClient
        .from("profiles")
        .update({
            username: username,
            address: address,
            phone: phone
        })
        .eq("id", userId);

    if (error) {
        console.error("Update error:", error);
        alert("Error updating profile.");
        return;
    }

    alert("Profile updated successfully!");

    // Lock fields again
    document.getElementById("profile_name").readOnly = true;
    document.getElementById("profile_address").readOnly = true;
    document.getElementById("profile_phone").readOnly = true;

    document.getElementById("saveBtn").style.display = "none";
    document.getElementById("editBtn").style.display = "block";

    loadUserProfile();
}

// Logout
async function handleLogout() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
}

</script>

</body>
</html>
